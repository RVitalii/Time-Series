---
title: "Forecasting The UK Inflation Rate 1965/Q1-2019/Q3"
author: "Vitalii Rudko"
date: "November, 2020"
output:
   bookdown::html_document2: 
       fig_caption: yes
       theme: readable
       toc: yes
---

# Preparing Data
This section is completely technical, so it may be omitted. 
```{r message=FALSE, warning=FALSE}
#Loading packages.
library(xts)
library(zoo)
library(dplyr)
library(arfima)
library(ggplot2)
library(LongMemoryTS)
library(forecast)
library(MTS)
library(roll)
library(fDMA)
library(tseries)
library(gridExtra)
library(arfima)
library(rugarch)
```

```{r}
#Importing data. 
data <- read.csv("D:/R_dir/AMM/UKrpiq.csv")
```

```{r}
#Extracting data. 
data <- data.frame(cbind(data$X, data$InflatQ))
names(data) <- c("Date", "InfQ")

#Formatting the Date column.
data$Date <- as.yearqtr(data$Date)

#Removing missing values.
data <- data %>% filter(InfQ != "#N/A")

#Formatting the InfQ column.
data$InfQ <- as.numeric(data$InfQ)

#Saving the last 4 observations.
last4 <- data %>% filter(Date > 2019.5)

#Narrowing the time window to 1965(1)-2019(3).
data <- data %>% filter(Date >= 1965 & Date <= 2019.5)
```

```{r}
#Creating time series.
inf.xts <- na.omit(xts(data$InfQ, order.by = data$Date))
inf.ts <- na.omit(ts(data$InfQ, start = c(1965,1), frequency = 4))
```

# Preliminary Analysis
At the first look, we guess that the series is non-stationary.
```{r}
#Plotting actual series of InfQ variable. 
ggplot(data)+
  geom_line(aes(x = Date, y = InfQ))+
  labs(title = "The UK Inflation Non-Seasonal Series(%)",
       y = expression('r'[inf]))+
  theme_light()
```

The ACF plot below shows a seasonal pattern of the order 4, thus seasonal differencing of that order must be considered. 
```{r}
#Plotting Acf and Pacf of non-seasonal series.
plot1 <- ggAcf(inf.xts)+
          theme_light()+
          labs(title = "ACF of Non-Seasonal Series")
plot2 <- ggPacf(inf.xts)+
          theme_light()+
          labs(title = "PACF of Non-Seasonal Series")

grid.arrange(plot1,
             plot2,
             nrow = 2)
```

ADF test accepts H0 -- the process is non-stationary. 
```{r}
#Testing stationarity of InfQ variable.
#H0: non-stationary;
#H1: stationary;
adf.test(inf.xts)
```

Ljung-Box test shows the presence of autocorrelation, which well seen in the  ACF plot. 
```{r}
#Ljung-Box for detecting autocorrelations in non-seasonal series.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(inf.ts, lag = 30, type = "Ljung-Box")
```

As we can see the data has non-normal distribution.
```{r}
#Plotting the distribution of non-seasonal series.
ggplot(data)+
      geom_density(aes(InfQ), fill = "Grey")+
      labs(title = "Distribution of the Non-Seasonal UK Inflation Series",
           x = expression('r'[inf]))+
  theme_light()
```

The Shapiro-Wilk test confirms it.  
```{r}
#Testing normality of the distribution of seasonal series with Shapiro-Wilk test.
#H0: data normaly distributed;
#H1: data is not normaly distributied;
shapiro.test(inf.ts)
```

ARCH tests reject a H0 in every case. Hovewer, it must be additionaly checked in seasonal series.
```{r}
#Testing ARCH effect in non-seasonal series.
#H0: there is no ARCH effect;
#H1: there is ARCH effect with a specified lag;
archtest(as.vector(inf.ts), lag = 2)
archtest(as.vector(inf.ts), lag = 5)
archtest(as.vector(inf.ts), lag = 10)
```


```{r}
#Calculating seasonal series.
data$InfQ_diff4 <- c(rep(NA, 4), diff(data$InfQ, lag = 4))
inf4.xts  <- na.omit(xts(data$InfQ_diff4, order.by = data$Date))
inf4.ts  <- na.omit(ts(data$InfQ_diff4, start = c(1948, 3), frequency = 4))
```

The seasonal series look stable.
```{r}
#Plotting actual series of InfQ_diff4 variable.
ggplot(na.omit(data))+
  geom_line(aes(x = Date, y = InfQ_diff4))+
  labs(title = "The UK Inflation Seasonal Series(%)",
       y = expression('r'[inf]))+
  theme_light()
```

ADF test confirms stationarity.
```{r}
#Testing stationarity of InfQ_diff4 variable.
#H0: non-stationary;
#H1: stationary;
adf.test(inf4.xts)
```

Parameters AR1 and SMA1 should be considered for the model, since at this point we observe high correlations. 
```{r}
#Plotting Acf and Pacf of seasonal series.
plot3 <- ggAcf(inf4.xts)+
          theme_light()+
          labs(title = "ACF of Seasonal Series")
plot4 <- ggPacf(inf4.xts)+
          theme_light()+
          labs(title = "PACF of Seasonal Series")

grid.arrange(plot3,
             plot4,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in seasonal series.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(inf4.ts, lag = 30, type = "Ljung-Box")
```

The distribution of seasonal data in non-normal as we see. 
```{r}
#Plotting the distribution of seasonal series.
ggplot(na.omit(data))+
      geom_density(aes(InfQ_diff4), fill = "Grey")+
      labs(title = "Distribution of the Seasonal UK Inflation Series",
           x = expression('r'[inf]))+
  theme_light()
```
```{r}
#Testing normality of the distribution of seasonal series with Shapiro-Wilk test.
#H0: data normaly distributed;
#H1: data is not normaly distributied;
shapiro.test(inf4.ts)
```

The ARCH effect is still present, therefore GARCH model must be considered.
```{r}
#Testing ARCH effect in seasonal series.
#H0: there is no ARCH effect;
#H1: there is ARCH effect with a specified lag;
archtest(as.vector(inf4.ts), lag = 2)
archtest(as.vector(inf4.ts), lag = 5)
archtest(as.vector(inf4.ts), lag = 10)
```

# Building ARFIMA with the 'rugarch' package
The rugarch package allows autoselection of the best specification according to the chosen criterion. All the parameters are statistically significant, d parameter is absent. The best specification is ARFIMA(4,0,3).
```{r}
#Autosearching for the best ARFIMA specification.
arfima <- autoarfima(data = inf.xts,  
           ar.max = 4, 
           ma.max = 4,
           criterion = "BIC", 
           method = "partial", 
           arfima = TRUE)
show(arfima)
```

As we can see the fit is good.
```{r}
#Plotting observed vs fitted. 
ggplot(data.frame(Date = data$Date, 
                  Observed = data$InfQ, 
                  Fitted = fitted(arfima$fit))) +
  geom_line(aes(x = Date, y = Observed, colour = "Observed")) +
  geom_line(aes(x = Date, y = Fitted, colour = "Fitted")) +
  labs(y = expression('r'[inf]), 
       title = "ARFIMA: Observed vs Fitted")+
  scale_color_manual(name = "",
                     labels = c("Observed", "Fitted"),
                     values = c("Observed" = "black",
                                "Fitted" = "red")) +
  theme_light()
```

The residuals are not normally distributed. 
```{r}
#Plotting distribution of residuals.
ggplot(data.frame(Residuals = as.vector(residuals(arfima$fit)))) +
  geom_density(aes(Residuals), fill = "Grey") +
  labs(title = "ARFIMA: The distribution of residuals") +
  theme_light()
```

```{r}
#Testing normality of the distribution of ARFIMA residuals with Shapiro-Wilk test.
#H0: data normaly distributed;
#H1: data is not normaly distributied;
shapiro.test(as.vector(residuals(arfima$fit)))
```
The correlations are present, the model violates fundametal assumtions.
```{r}
#Plotting Acf and Pacf of ARFIMA residuals.
plot5 <- ggAcf(as.vector(residuals(arfima$fit)))+
          theme_light()+
          labs(title = "ARFIMA: ACF of Residuals")
plot6 <- ggPacf(as.vector(residuals(arfima$fit)))+
          theme_light()+
          labs(title = "ARFIMA: PACF of Residuals")

grid.arrange(plot5,
             plot6,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in ARFIMA residuals.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(as.vector(residuals(arfima$fit)), lag = 30, type = "Ljung-Box")
```
The ACF plot of squared series, for future GARCH analysis.  
```{r}
#Plotting Acf and Pacf of ARFIMA squared residuals.
plot7 <- ggAcf(as.vector(residuals(arfima$fit))^2)+
          theme_light()+
          labs(title = "ARFIMA: ACF of Squared Residuals")
plot8 <- ggPacf(as.vector(residuals(arfima$fit))^2)+
         theme_light()+
        labs(title = "ARFIMA: PACF of Squared Residuals")

grid.arrange(plot7,
             plot8,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in squared residuals.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(as.vector(residuals(arfima$fit))^2, lag = 30, type = "Ljung-Box")
```

The forecasted values diviate from the observed  ones. 
```{r}
#Calculating 4 forecasts.
arfima.forecast <- arfimaforecast(arfima$fit,
                                  inf.xts,
                                  n.ahead = 4)

#Plotting forecasted vs observed.
ggplot(data.frame(Date = last4$Date, 
                  Observed = last4$InfQ,
                  Forecasted = as.vector(fitted(arfima.forecast)))) +
      geom_ribbon(aes(x = Date,
                      y = Forecasted,
                      ymin = Forecasted - 3.14141 , 
                      ymax = Forecasted + 3.14141), 
              fill = "royalblue3",
              alpha=0.4) +
  geom_line(aes(x = Date, y = Forecasted, colour = "Forecasted")) +
  geom_line(aes(x = Date, y = Observed, colour = "Observed")) +
  labs(y = expression('r'[inf]), 
       title = "ARFIMA: Observed vs Forecasted")+
  scale_color_manual(name = "",
                     labels = c("Forecasted", "Observed"),
                     values = c("Observed" = "black",
                                "Forecasted" = "red")) +
  theme_light()
```

# Building SARIMA with the 'forecast' package
The 'forecast' package also anables auto-selection, but unfortunately the report is not informative enough. The best specification is ARIMA(1,1,1)(1,0,0)[4]. 
```{r}
#Autosearching for the best SARIMA specification.
sarima <- auto.arima(inf.ts,
                    trace = TRUE)
sarima 
```

The fit looks ok.
```{r}
#Plotting observed vs fitted. 
ggplot(data.frame(Date = data$Date,
                  Observed = data$InfQ,
                  Fitted = sarima$fitted)) +
  geom_line(aes(x = Date, y = Observed, col = "Observed")) +
  geom_line(aes(x = Date, y = Fitted, col = "Fitted")) +
  labs(y = expression('r'[inf]), 
       title = "SARIMA: Observed vs Fitted")+
  scale_color_manual(name = "",
                     values = c("Observed" = "black",
                                "Fitted" = "red")) +
  theme_light()
```

The picture the same as in the previous case.
```{r}
#Plotting distribution of residuals.
ggplot(data.frame(Residuals = as.vector(sarima$residuals))) +
  geom_density(aes(Residuals), fill = "Grey") +
  labs(title = "SARIMA: The distribution of residuals") +
  theme_light()
```

```{r}
#Testing normality of the distribution of SARIMA residuals with Shapiro-Wilk test.
#H0: data normaly distributed;
#H1: data is not normaly distributied;
shapiro.test(as.vector(sarima$residuals))
```

```{r}
#Plotting Acf and Pacf of SARIMA residuals.
plot9 <- ggAcf(as.vector(sarima$residuals))+
          theme_light()+
          labs(title = "SARIMA: ACF of Residuals")
plot10 <- ggPacf(as.vector(sarima$residuals))+
          theme_light()+
          labs(title = "SARIMA: PACF of Residuals")

grid.arrange(plot9,
             plot10,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in SARIMA residuals.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(as.vector(sarima$residuals), lag = 30, type = "Ljung-Box")
```


```{r}
#Plotting Acf and Pacf of SARIMA squared residuals.
plot11 <- ggAcf(as.vector(sarima$residuals)^2)+
          theme_light()+
          labs(title = "SARIMA: ACF of Squared Residuals")
plot12 <- ggPacf(as.vector(sarima$residuals)^2)+
         theme_light()+
        labs(title = "SARIMA: PACF of Squared Residuals")

grid.arrange(plot11,
             plot12,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in SARIMA residuals.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(as.vector(sarima$residuals)^2, lag = 30, type = "Ljung-Box")
```

The forecast is more or less correct in the two periods 2020/Q1 and 2020/Q3.
```{r}
#Calculating 4 forecasts.
sarima.forecast <- forecast(sarima, h = 4)

#Plotting forecasted vs observed.
ggplot(data.frame(Date = last4$Date, 
                  Observed = last4$InfQ,
                  Forecasted = as.vector(sarima.forecast$mean))) +
      geom_ribbon(aes(x = Date,
                      y = Forecasted,
                      ymin = as.vector(sarima.forecast$mean - 11.79^0.5), 
                      ymax = as.vector(sarima.forecast$mean + 11.79^0.5)), 
              fill = "royalblue3",
              alpha=0.4) +
  geom_line(aes(x = Date, y = Forecasted, colour = "Forecasted")) +
  geom_line(aes(x = Date, y = Observed, colour = "Observed")) +
  labs(y = expression('r'[inf]), 
       title = "SARIMA: Observed vs Forecasted")+
  scale_color_manual(name = "",
                     labels = c("Forecasted", "Observed"),
                     values = c("Observed" = "black",
                                "Forecasted" = "red")) +
  theme_light()
```

# Building SARFIMA with the 'arfima' package
The 'arfima' package enables SARFIMA modelling, but specifications must be provided mannualy. After some trials I chose SARFIMA(4, 0, 1)(2,0.37,0)[4] specification with dummy variables.
```{r warning=FALSE}
#Building SARFIMA
sarfima <- arfima::arfima(inf.ts, 
                          order = c(4,0,1),
                          seasonal = list(order = c(2, 0, 0),
                          period = 4),
                          fixed = list(frac = c(0),
                                       seasonal = list(phi = c(0, NA),
                                                       frac = c(NA))))
summary(sarfima)
```

```{r}
#Extracting residuals and fitted values.
sarfima.res <- ts(as.vector(unlist(residuals(sarfima))), start = c(1965), frequency = 4)
sarfima.fit <- as.vector(unlist(fitted(sarfima)))
sarfima.forecast <- predict(sarfima, n.ahead = 4)
```

The shape of the fit looks batter than in previous cases.
```{r}
start <- length(data$Date)-length(sarfima.fit)+1

ggplot(data.frame(Date = data$Date[start:length(data$Date)], 
                  Observed = data$InfQ[start:length(data$Date)],
                  Fitted = sarfima.fit))+
  geom_line(aes(x = Date, y = Observed, colour = "Observed")) +
  geom_line(aes(x = Date, y = Fitted, colour = "Fitted")) +
  labs(y = expression('r'[inf]), 
       title = "SARFIMA: Observed vs Fitted")+
  scale_color_manual(name = "",
                     values = c("Observed" = "black",
                                "Fitted" = "red")) +
  theme_light()
```

The distribution is still has non-normal shape.
```{r}
#Plotting distribution of residuals.
ggplot(data.frame(Residuals = as.vector(sarfima.res))) +
  geom_density(aes(Residuals), fill = "Grey") +
  labs(title = "SARFIMA: The distribution of residuals") +
  theme_light()
```
```{r}
#Testing normality of the distribution of SARFIMA residuals with Shapiro-Wilk test.
#H0: data normaly distributed;
#H1: data is not normaly distributied;
shapiro.test(as.vector(sarfima.res))
```

Hovewer, the residuals are not correlated anymore.
```{r}
#Plotting Acf and Pacf of SARFIMA residuals.
plot13 <- ggAcf(as.vector(sarfima.res))+
          theme_light()+
          labs(title = "SARFIMA: ACF of Residuals")
plot14 <- ggPacf(as.vector(sarfima.res))+
          theme_light()+
          labs(title = "SARFIMA: PACF of Residuals")

grid.arrange(plot13,
             plot14,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in SARFIMA residuals.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(as.vector(sarfima.res), lag = 30, type = "Ljung-Box")
```

Although, the squared residuals show some dependence, so the GARCH model should be considered. 
```{r}
#Plotting Acf and Pacf of SARFIMA squared residuals.
plot11 <- ggAcf(as.vector(sarfima.res)^2)+
          theme_light()+
          labs(title = "ARIMA: ACF of Squared Residuals")
plot12 <- ggPacf(as.vector(sarfima.res)^2)+
         theme_light()+
        labs(title = "ARIMA: PACF of Squared Residuals")

grid.arrange(plot11,
             plot12,
             nrow = 2)
```

```{r}
#Ljung-Box for detecting autocorrelations in SARFIMA residuals.
#H0: all correlations are zero;
#H1: there exists at least one, which is significantly higher than zero;
Box.test(as.vector(sarfima.res)^2, lag = 30, type = "Ljung-Box")
```

The forecast accuracy is the same as in the case of SARIMA model.
```{r}
#Plotting forecasted vs observed.
ggplot(data.frame(Date = last4$Date, 
                  Observed = last4$InfQ,
                  Forecasted = sarfima.forecast[[1]]$Forecast)) +
      geom_ribbon(aes(x = Date,
                      y = Forecasted,
                      ymin = sarfima.forecast[[1]]$Forecast - sarfima.forecast[[1]]$SDForecasts, 
                      ymax = sarfima.forecast[[1]]$Forecast + sarfima.forecast[[1]]$SDForecasts), 
              fill = "royalblue3",
              alpha=0.4) +
  geom_line(aes(x = Date, y = Forecasted, colour = "Forecasted")) +
  geom_line(aes(x = Date, y = Observed, colour = "Observed")) +
  labs(y = expression('r'[inf]), 
       title = "SARFIMA: Observed vs Forecasted")+
  scale_color_manual(name = "",
                     labels = c("Forecasted", "Observed"),
                     values = c("Observed" = "black",
                                "Forecasted" = "red")) +
  theme_light()
```

